{% extends "base.html" %}

{% block title %}Tournament Details - Tournament Manager{% endblock %}

{% block extra_styles %}
<style>
    .match-card {
        background: white;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 15px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    .match-round {
        font-size: 0.85em;
        color: #6b7280;
        font-weight: 600;
        margin-bottom: 8px;
    }
    .match-teams {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin: 10px 0;
    }
    .match-team {
        flex: 1;
        text-align: center;
        font-weight: 600;
        padding: 10px;
    }
    .match-team.winner {
        background: #d1fae5;
        border-radius: 6px;
        color: #065f46;
    }
    .match-team.loser {
        color: #9ca3af;
    }
    .match-vs {
        padding: 0 15px;
        color: #9ca3af;
        font-weight: 700;
    }
    .match-status {
        text-align: center;
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 0.85em;
        font-weight: 500;
    }
    .match-pending { background: #fef3c7; color: #92400e; }
    .match-completed { background: #d1fae5; color: #065f46; }
    .match-abandoned { background: #fee2e2; color: #991b1b; }
    .match-actions {
        display: flex;
        gap: 10px;
        margin-top: 10px;
        justify-content: center;
    }
    .standings-table {
        width: 100%;
    }
    .standings-table th, .standings-table td {
        text-align: center;
    }
    .standings-table .rank-1 { background: #fef3c7; }
    .standings-table .rank-2 { background: #e5e7eb; }
    .standings-table .rank-3 { background: #fed7aa; }
</style>
{% endblock %}

{% block content %}
<div class="breadcrumb">
    <a href="/tournaments">Tournaments</a> / Current Tournament
</div>

<div id="messageContainer"></div>

<div id="tournamentHeader">
    <div class="empty-state">Loading tournament...</div>
</div>

<div class="section" id="matchesSection">
    <h2>Current Round Matches</h2>
    <div id="matchesList">
        <div class="empty-state">Loading matches...</div>
    </div>
</div>

<div class="section" id="standingsSection" style="display: none;">
    <h2>Standings</h2>
    <div id="standingsList"></div>
</div>
{% endblock %}

{% block scripts %}
<script>
    function showMessage(msg, isError = false) {
        const container = document.getElementById('messageContainer');
        container.innerHTML = `<div class="message ${isError ? 'message-error' : 'message-success'}">${msg}</div>`;
        setTimeout(() => container.innerHTML = '', 3000);
    }

    async function loadTournament() {
        try {
            const [stateRes, teamsRes, matchesRes] = await Promise.all([
                fetch('/api/tournament/state'),
                fetch('/api/teams'),
                fetch('/api/matches')
            ]);

            const state = await stateRes.json();
            const teams = await teamsRes.json();
            const matches = await matchesRes.json();

            renderHeader(state, teams);
            renderMatches(matches, teams);

            if (state.type === 'round_robin') {
                renderStandings(teams);
            }
        } catch (error) {
            console.error('Error loading tournament:', error);
        }
    }

    function renderHeader(state, teams) {
        const typeLabel = state.type === 'round_robin' ? 'Round Robin' : 'Single Elimination';
        const statusBadgeClass = {
            'registration': 'badge-registration',
            'active': 'badge-active',
            'completed': 'badge-completed'
        }[state.status] || 'badge-registration';

        let winnerHtml = '';
        if (state.winner && teams[state.winner]) {
            winnerHtml = `
                <div style="margin-top: 20px; padding: 20px; background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%); border-radius: 8px; color: #78350f; text-align: center;">
                    <div style="font-size: 2em;">üèÜ</div>
                    <div style="font-size: 1.5em; font-weight: 700; margin-top: 10px;">${teams[state.winner].name}</div>
                    <div>Tournament Champion</div>
                </div>
            `;
        }

        document.getElementById('tournamentHeader').innerHTML = `
            <div class="header-actions">
                <div>
                    <h1>${typeLabel}</h1>
                    <span class="badge ${statusBadgeClass}">${state.status}</span>
                    ${state.round > 0 ? `<span style="margin-left: 10px; color: #6b7280;">Round ${state.round}${state.total_rounds ? ' of ' + state.total_rounds : ''}</span>` : ''}
                </div>
                <a href="/tournaments" class="btn btn-secondary">Back to Tournaments</a>
            </div>
            ${winnerHtml}
        `;
    }

    function renderMatches(matches, teams) {
        const container = document.getElementById('matchesList');

        if (matches.length === 0) {
            container.innerHTML = '<div class="empty-state">No matches in this round</div>';
            return;
        }

        container.innerHTML = matches.map(match => {
            const team1 = teams[match.team1];
            const team2 = teams[match.team2];

            if (!team1 || !team2) return '';

            let statusClass = 'match-pending';
            let statusText = 'Pending';
            if (match.status === 'completed') {
                statusClass = 'match-completed';
                statusText = `Winner: ${teams[match.winner]?.name || 'Unknown'}`;
            } else if (match.status === 'abandoned') {
                statusClass = 'match-abandoned';
                statusText = 'Abandoned';
            }

            const team1Class = match.winner === match.team1 ? 'winner' : (match.winner === match.team2 ? 'loser' : '');
            const team2Class = match.winner === match.team2 ? 'winner' : (match.winner === match.team1 ? 'loser' : '');

            return `
                <div class="match-card">
                    <div class="match-round">Round ${match.round || '?'}</div>
                    <div class="match-status ${statusClass}">${statusText}</div>
                    <div class="match-teams">
                        <div class="match-team ${team1Class}">${team1.name}</div>
                        <div class="match-vs">VS</div>
                        <div class="match-team ${team2Class}">${team2.name}</div>
                    </div>
                    ${match.status === 'pending' ? `
                        <div class="match-actions">
                            <button class="btn btn-small" onclick="recordResult('${match.id}', '${match.team1}')">
                                ${team1.name} Wins
                            </button>
                            <button class="btn btn-small" onclick="recordResult('${match.id}', '${match.team2}')">
                                ${team2.name} Wins
                            </button>
                        </div>
                    ` : ''}
                </div>
            `;
        }).join('');
    }

    function renderStandings(teams) {
        const section = document.getElementById('standingsSection');
        section.style.display = 'block';

        const sorted = Object.entries(teams)
            .map(([id, team]) => ({ id, ...team }))
            .sort((a, b) => {
                if (b.wins !== a.wins) return b.wins - a.wins;
                return a.losses - b.losses;
            });

        document.getElementById('standingsList').innerHTML = `
            <table class="standings-table">
                <thead>
                    <tr>
                        <th>Rank</th>
                        <th>Team</th>
                        <th>Wins</th>
                        <th>Losses</th>
                        <th>Win Rate</th>
                    </tr>
                </thead>
                <tbody>
                    ${sorted.map((team, idx) => {
                        const total = team.wins + team.losses;
                        const winRate = total > 0 ? Math.round(team.wins / total * 100) : 0;
                        const rankClass = idx < 3 ? `rank-${idx + 1}` : '';
                        return `
                            <tr class="${rankClass}">
                                <td><strong>${idx + 1}</strong></td>
                                <td><a href="/teams/${team.id}">${team.name}</a></td>
                                <td>${team.wins}</td>
                                <td>${team.losses}</td>
                                <td>${winRate}%</td>
                            </tr>
                        `;
                    }).join('')}
                </tbody>
            </table>
        `;
    }

    async function recordResult(matchId, winner) {
        try {
            const response = await fetch(`/api/matches/${matchId}/result`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ winner })
            });

            const data = await response.json();

            if (response.ok) {
                showMessage('Match result recorded!');
                loadTournament();
            } else {
                showMessage(data.error || 'Failed to record result', true);
            }
        } catch (error) {
            showMessage('Error recording result', true);
        }
    }

    loadTournament();
    setInterval(loadTournament, 5000);
</script>
{% endblock %}
