<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tournament Manager</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 30px;
        }
        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 2.5em;
        }
        .status-badge {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            margin-bottom: 20px;
            font-size: 0.9em;
        }
        .status-registration {
            background: #fbbf24;
            color: #78350f;
        }
        .status-active {
            background: #34d399;
            color: #064e3b;
        }
        .status-completed {
            background: #60a5fa;
            color: #1e3a8a;
        }
        .section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f9fafb;
            border-radius: 8px;
        }
        .section h2 {
            color: #1f2937;
            margin-bottom: 15px;
            font-size: 1.5em;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            color: #374151;
            font-weight: 500;
        }
        input {
            width: 100%;
            padding: 10px;
            border: 2px solid #d1d5db;
            border-radius: 6px;
            font-size: 1em;
            transition: border-color 0.3s;
        }
        input:focus {
            outline: none;
            border-color: #667eea;
        }
        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s;
        }
        button:hover {
            background: #5568d3;
        }
        button:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }
        .btn-reset {
            background: #ef4444;
            margin-left: 10px;
        }
        .btn-reset:hover {
            background: #dc2626;
        }
        .header-controls {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }
        .teams-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        .team-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 2px solid #e5e7eb;
        }
        .team-name {
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 5px;
        }
        .team-captain {
            color: #6b7280;
            font-size: 0.9em;
        }
        .team-record {
            margin-top: 8px;
            font-size: 0.85em;
            color: #059669;
            font-weight: 600;
        }
        .matches-list {
            margin-top: 15px;
        }
        .match-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 15px;
            border: 2px solid #e5e7eb;
        }
        .match-teams {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .match-team {
            flex: 1;
            text-align: center;
            font-weight: 600;
            color: #1f2937;
        }
        .match-vs {
            padding: 0 20px;
            color: #9ca3af;
            font-weight: 700;
        }
        .match-status {
            text-align: center;
            padding: 8px;
            border-radius: 6px;
            font-weight: 600;
            margin-bottom: 10px;
        }
        .match-pending {
            background: #fef3c7;
            color: #92400e;
        }
        .match-completed {
            background: #d1fae5;
            color: #065f46;
        }
        .match-abandoned {
            background: #fee2e2;
            color: #991b1b;
        }
        .match-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
        }
        .btn-small {
            padding: 8px 16px;
            font-size: 0.9em;
        }
        .winner-display {
            text-align: center;
            padding: 20px;
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
            border-radius: 8px;
            color: #78350f;
            font-size: 1.5em;
            font-weight: 700;
        }
        .standings-table {
            background: white;
            border-radius: 8px;
            overflow: hidden;
        }
        .standings-row {
            display: grid;
            grid-template-columns: 60px 1fr 100px 100px;
            padding: 12px;
            border-bottom: 1px solid #e5e7eb;
            align-items: center;
        }
        .standings-row:first-child {
            background: #f3f4f6;
            font-weight: 700;
            color: #1f2937;
        }
        .standings-row:not(:first-child):hover {
            background: #f9fafb;
        }
        .standings-rank {
            font-weight: 700;
            color: #667eea;
        }
        select {
            width: 100%;
            padding: 10px;
            border: 2px solid #d1d5db;
            border-radius: 6px;
            font-size: 1em;
            transition: border-color 0.3s;
            background: white;
        }
        select:focus {
            outline: none;
            border-color: #667eea;
        }
        .hidden {
            display: none;
        }
        .message {
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 15px;
            font-weight: 500;
        }
        .message-success {
            background: #d1fae5;
            color: #065f46;
        }
        .message-error {
            background: #fee2e2;
            color: #991b1b;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header-controls">
            <div>
                <h1>Tournament Manager</h1>
                <div id="statusBadge" class="status-badge status-registration">Registration Open</div>
            </div>
            <button class="btn-reset" onclick="resetTournament()">ðŸ”„ Reset Tournament</button>
        </div>
        
        <div id="messageContainer"></div>
        
        <div id="registrationSection" class="section">
            <h2>Register Team</h2>
            <div class="form-group">
                <label for="captainName">Captain Name</label>
                <input type="text" id="captainName" placeholder="Enter captain name">
            </div>
            <div class="form-group">
                <label for="teamName">Team Name</label>
                <input type="text" id="teamName" placeholder="Enter team name">
            </div>
            <button onclick="registerTeam()">Register Team</button>
            
            <div class="form-group" style="margin-top: 20px;">
                <label for="tournamentType">Tournament Type</label>
                <select id="tournamentType" style="width: 100%; padding: 10px; border: 2px solid #d1d5db; border-radius: 6px; font-size: 1em;">
                    <option value="single_elimination">Single Elimination (Min 4 teams)</option>
                    <option value="round_robin">Round Robin (Min 2 teams)</option>
                </select>
            </div>
            <button onclick="startTournament()" style="margin-top: 10px; background: #10b981; width: 100%;">Start Tournament</button>
        </div>
        
        <div class="section">
            <h2>Registered Teams</h2>
            <div id="teamsList" class="teams-grid"></div>
        </div>
        
        <div id="matchesSection" class="section hidden">
            <h2>Current Round Matches</h2>
            <div id="matchesList" class="matches-list"></div>
        </div>
        
        <div id="winnerSection" class="section hidden">
            <h2>Tournament Complete!</h2>
            <div id="winnerDisplay" class="winner-display"></div>
            <div id="standingsDisplay" class="hidden" style="margin-top: 20px;">
                <h3 style="color: #1f2937; margin-bottom: 15px;">Final Standings</h3>
                <div id="standingsList"></div>
            </div>
        </div>
    </div>

    <script>
        let currentState = null;
        
        function showMessage(message, isError = false) {
            const container = document.getElementById('messageContainer');
            const div = document.createElement('div');
            div.className = `message ${isError ? 'message-error' : 'message-success'}`;
            div.textContent = message;
            container.appendChild(div);
            setTimeout(() => div.remove(), 5000);
        }
        
        async function registerTeam() {
            const captainName = document.getElementById('captainName').value.trim();
            const teamName = document.getElementById('teamName').value.trim();
            
            if (!captainName || !teamName) {
                showMessage('Please enter both captain name and team name', true);
                return;
            }
            
            try {
                const response = await fetch('/api/teams/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ captain_name: captainName, team_name: teamName })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    showMessage('Team registered successfully!');
                    document.getElementById('captainName').value = '';
                    document.getElementById('teamName').value = '';
                    loadTeams();
                } else {
                    showMessage(data.error || 'Registration failed', true);
                }
            } catch (error) {
                showMessage('Error registering team', true);
            }
        }
        
        async function startTournament() {
            const tournamentType = document.getElementById('tournamentType').value;
            
            try {
                const response = await fetch('/api/tournament/start', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ type: tournamentType })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    showMessage(data.message || 'Tournament started!');
                    loadTournamentState();
                } else {
                    showMessage(data.error || 'Failed to start tournament', true);
                }
            } catch (error) {
                showMessage('Error starting tournament', true);
            }
        }
        
        async function resetTournament() {
            if (!confirm('Are you sure you want to reset the tournament? All data will be lost and 8 new random teams will be created.')) {
                return;
            }
            
            try {
                const response = await fetch('/api/tournament/reset', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    showMessage(data.message || 'Tournament reset successfully!');
                    
                    // Clear all sections
                    document.getElementById('matchesList').innerHTML = '';
                    document.getElementById('winnerDisplay').textContent = '';
                    document.getElementById('standingsDisplay').classList.add('hidden');
                    
                    // Force full reload of all data
                    await loadTournamentState();
                    await loadTeams();
                    
                    // Reload page after short delay to ensure clean state
                    setTimeout(() => {
                        window.location.reload();
                    }, 1000);
                } else {
                    showMessage(data.error || 'Failed to reset tournament', true);
                }
            } catch (error) {
                showMessage('Error resetting tournament', true);
            }
        }
        
        async function recordMatchResult(matchId, winner) {
            console.log('Recording match result:', { matchId, winner });
            
            try {
                const response = await fetch(`/api/matches/${matchId}/result`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ winner: winner })
                });
                
                const data = await response.json();
                console.log('Match result response:', data);
                
                if (response.ok) {
                    showMessage('Match result recorded!');
                    await loadMatches();
                    await loadTeams();
                    await loadTournamentState();
                } else {
                    console.error('Failed to record result:', data);
                    showMessage(data.error || 'Failed to record result', true);
                }
            } catch (error) {
                console.error('Error recording result:', error);
                showMessage('Error recording result: ' + error.message, true);
            }
        }
        
        async function loadTournamentState() {
            try {
                const response = await fetch('/api/tournament/state');
                const state = await response.json();
                currentState = state;
                
                const badge = document.getElementById('statusBadge');
                const registrationSection = document.getElementById('registrationSection');
                const matchesSection = document.getElementById('matchesSection');
                const winnerSection = document.getElementById('winnerSection');
                
                const tournamentTypeText = state.type === 'round_robin' ? 'Round Robin' : 'Single Elimination';
                
                if (state.status === 'registration') {
                    badge.textContent = `Registration Open - ${tournamentTypeText}`;
                    badge.className = 'status-badge status-registration';
                    registrationSection.classList.remove('hidden');
                    matchesSection.classList.add('hidden');
                    winnerSection.classList.add('hidden');
                } else if (state.status === 'active') {
                    let roundText = `Round ${state.round}`;
                    if (state.type === 'round_robin' && state.total_rounds) {
                        roundText += ` of ${state.total_rounds}`;
                    }
                    badge.textContent = `${roundText} - ${tournamentTypeText}`;
                    badge.className = 'status-badge status-active';
                    registrationSection.classList.add('hidden');
                    matchesSection.classList.remove('hidden');
                    winnerSection.classList.add('hidden');
                    loadMatches();
                } else if (state.status === 'completed') {
                    badge.textContent = `${tournamentTypeText} - Completed`;
                    badge.className = 'status-badge status-completed';
                    registrationSection.classList.add('hidden');
                    matchesSection.classList.add('hidden');
                    winnerSection.classList.remove('hidden');
                    
                    if (state.winner) {
                        loadTeams().then(teams => {
                            const winnerTeam = teams[state.winner];
                            document.getElementById('winnerDisplay').textContent = 
                                `ðŸ† ${winnerTeam.name} (Captain: ${winnerTeam.captain})`;
                        });
                    } else {
                        document.getElementById('winnerDisplay').textContent = 
                            'Tournament ended with no winner (all matches abandoned)';
                    }
                    
                    if (state.type === 'round_robin' && state.standings) {
                        displayStandings(state.standings);
                    }
                }
            } catch (error) {
                console.error('Error loading tournament state:', error);
            }
        }
        
        async function loadTeams() {
            try {
                const response = await fetch('/api/teams');
                const teams = await response.json();
                
                const teamsList = document.getElementById('teamsList');
                teamsList.innerHTML = '';
                
                Object.entries(teams).forEach(([teamId, team]) => {
                    const card = document.createElement('div');
                    card.className = 'team-card';
                    card.innerHTML = `
                        <div class="team-name">${team.name}</div>
                        <div class="team-captain">Captain: ${team.captain}</div>
                        <div class="team-record">W: ${team.wins} - L: ${team.losses}</div>
                    `;
                    teamsList.appendChild(card);
                });
                
                return teams;
            } catch (error) {
                console.error('Error loading teams:', error);
            }
        }
        
        async function loadMatches() {
            try {
                const response = await fetch('/api/matches');
                const matches = await response.json();
                
                const teamsResponse = await fetch('/api/teams');
                const teams = await teamsResponse.json();
                
                const matchesList = document.getElementById('matchesList');
                matchesList.innerHTML = '';
                
                matches.forEach(match => {
                    const team1 = teams[match.team1];
                    const team2 = teams[match.team2];
                    
                    const card = document.createElement('div');
                    card.className = 'match-card';
                    
                    let statusClass = 'match-pending';
                    let statusText = 'Pending';
                    if (match.status === 'completed') {
                        statusClass = 'match-completed';
                        const winner = teams[match.winner];
                        statusText = `Winner: ${winner.name}`;
                    } else if (match.status === 'abandoned') {
                        statusClass = 'match-abandoned';
                        statusText = 'Abandoned - Both teams eliminated';
                    }
                    
                    const roundLabel = match.round ? `Round ${match.round}` : '';
                    
                    card.innerHTML = `
                        ${roundLabel ? `<div style="font-size: 0.85em; color: #6b7280; font-weight: 600; margin-bottom: 8px;">${roundLabel}</div>` : ''}
                        <div class="match-status ${statusClass}">${statusText}</div>
                        <div class="match-teams">
                            <div class="match-team">${team1.name}</div>
                            <div class="match-vs">VS</div>
                            <div class="match-team">${team2.name}</div>
                        </div>
                        ${match.status === 'pending' ? `
                            <div class="match-actions">
                                <button class="btn-small" onclick="recordMatchResult('${match.id}', '${match.team1}')">
                                    ${team1.name} Wins
                                </button>
                                <button class="btn-small" onclick="recordMatchResult('${match.id}', '${match.team2}')">
                                    ${team2.name} Wins
                                </button>
                            </div>
                        ` : ''}
                    `;
                    matchesList.appendChild(card);
                });
            } catch (error) {
                console.error('Error loading matches:', error);
            }
        }
        
        function displayStandings(standings) {
            const standingsDisplay = document.getElementById('standingsDisplay');
            const standingsList = document.getElementById('standingsList');
            
            standingsDisplay.classList.remove('hidden');
            
            let html = '<div class="standings-table">';
            html += '<div class="standings-row">';
            html += '<div>Rank</div><div>Team</div><div>Wins</div><div>Losses</div>';
            html += '</div>';
            
            standings.forEach((standing, index) => {
                html += '<div class="standings-row">';
                html += `<div class="standings-rank">#${index + 1}</div>`;
                html += `<div>${standing.team_id}</div>`;
                html += `<div>${standing.wins}</div>`;
                html += `<div>${standing.losses}</div>`;
                html += '</div>';
            });
            
            html += '</div>';
            standingsList.innerHTML = html;
            
            loadTeams().then(teams => {
                standings.forEach((standing, index) => {
                    const team = teams[standing.team_id];
                    if (team) {
                        const rows = standingsList.querySelectorAll('.standings-row');
                        if (rows[index + 1]) {
                            rows[index + 1].children[1].textContent = team.name;
                        }
                    }
                });
            });
        }
        
        async function checkAutoAdvance() {
            if (currentState && currentState.status === 'active') {
                try {
                    await fetch('/api/tournament/auto-advance', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' }
                    });
                    loadTournamentState();
                    loadMatches();
                    loadTeams();
                } catch (error) {
                    console.error('Error checking auto-advance:', error);
                }
            }
        }
        
        loadTournamentState();
        loadTeams();
        
        setInterval(() => {
            loadTournamentState();
            loadTeams();
            if (currentState && currentState.status === 'active') {
                loadMatches();
            }
        }, 5000);
        
        setInterval(checkAutoAdvance, 10000);
    </script>
</body>
</html>
