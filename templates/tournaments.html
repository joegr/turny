{% extends "base.html" %}

{% block title %}Tournaments - Tournament Manager{% endblock %}

{% block content %}
<div class="header-actions">
    <h1>Tournaments</h1>
    <button onclick="showCreateForm()">+ New Tournament</button>
</div>

<div id="messageContainer"></div>

<div id="createForm" class="section" style="display: none;">
    <h2>Start New Tournament</h2>
    <div style="display: grid; grid-template-columns: 1fr auto auto; gap: 15px; align-items: end;">
        <div>
            <label style="display: block; margin-bottom: 5px; font-weight: 500;">Tournament Type</label>
            <select id="tournamentType" style="width: 100%; padding: 10px; border: 2px solid #d1d5db; border-radius: 6px; background: white;">
                <option value="single_elimination">Single Elimination</option>
                <option value="round_robin">Round Robin</option>
            </select>
        </div>
        <div>
            <button onclick="startTournament()">Start Tournament</button>
        </div>
        <div>
            <button class="btn-secondary" onclick="hideCreateForm()">Cancel</button>
        </div>
    </div>
</div>

<div class="section">
    <h2>Current Tournament</h2>
    <div id="currentTournament">
        <div class="empty-state">Loading...</div>
    </div>
</div>

<div class="section">
    <h2>Tournament History</h2>
    <div id="tournamentHistory">
        <div class="empty-state">No completed tournaments yet</div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    function showMessage(msg, isError = false) {
        const container = document.getElementById('messageContainer');
        container.innerHTML = `<div class="message ${isError ? 'message-error' : 'message-success'}">${msg}</div>`;
        setTimeout(() => container.innerHTML = '', 3000);
    }

    function showCreateForm() {
        document.getElementById('createForm').style.display = 'block';
    }

    function hideCreateForm() {
        document.getElementById('createForm').style.display = 'none';
    }

    async function startTournament() {
        const tournamentType = document.getElementById('tournamentType').value;

        try {
            const response = await fetch('/api/tournament/start', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ type: tournamentType })
            });

            const data = await response.json();

            if (response.ok) {
                showMessage(data.message || 'Tournament started!');
                hideCreateForm();
                loadCurrentTournament();
            } else {
                showMessage(data.error || 'Failed to start tournament', true);
            }
        } catch (error) {
            showMessage('Error starting tournament', true);
        }
    }

    async function resetTournament() {
        if (!confirm('Are you sure you want to reset the tournament? All data will be lost.')) {
            return;
        }

        try {
            const response = await fetch('/api/tournament/reset', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            });

            const data = await response.json();

            if (response.ok) {
                showMessage(data.message || 'Tournament reset!');
                loadCurrentTournament();
            } else {
                showMessage(data.error || 'Failed to reset tournament', true);
            }
        } catch (error) {
            showMessage('Error resetting tournament', true);
        }
    }

    async function loadCurrentTournament() {
        try {
            const response = await fetch('/api/tournament/state');
            const state = await response.json();

            const container = document.getElementById('currentTournament');

            const statusBadgeClass = {
                'registration': 'badge-registration',
                'active': 'badge-active',
                'completed': 'badge-completed'
            }[state.status] || 'badge-registration';

            const typeLabel = state.type === 'round_robin' ? 'Round Robin' : 'Single Elimination';

            container.innerHTML = `
                <div class="card" style="box-shadow: none;">
                    <div style="display: flex; justify-content: space-between; align-items: start;">
                        <div>
                            <div class="card-title">${typeLabel}</div>
                            <span class="badge ${statusBadgeClass}">${state.status}</span>
                            ${state.round > 0 ? `<span style="margin-left: 10px; color: #6b7280;">Round ${state.round}${state.total_rounds ? ' of ' + state.total_rounds : ''}</span>` : ''}
                        </div>
                        <div style="display: flex; gap: 10px;">
                            ${state.status !== 'registration' ? `<a href="/tournaments/current" class="btn btn-small">View Details</a>` : ''}
                            <button class="btn-small btn-danger" onclick="resetTournament()">Reset</button>
                        </div>
                    </div>
                    ${state.winner ? `
                        <div style="margin-top: 15px; padding: 15px; background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%); border-radius: 8px; color: #78350f;">
                            <strong>üèÜ Winner:</strong> <span id="winnerName">Loading...</span>
                        </div>
                    ` : ''}
                </div>
            `;

            if (state.winner) {
                const teamsResponse = await fetch('/api/teams');
                const teams = await teamsResponse.json();
                const winner = teams[state.winner];
                if (winner) {
                    document.getElementById('winnerName').textContent = winner.name;
                }
            }
        } catch (error) {
            console.error('Error loading tournament:', error);
        }
    }

    loadCurrentTournament();
</script>
{% endblock %}
