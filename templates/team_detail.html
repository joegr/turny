{% extends "base.html" %}

{% block title %}Team Details - Tournament Manager{% endblock %}

{% block content %}
<div class="breadcrumb">
    <a href="/teams">Teams</a> / <span id="teamNameBreadcrumb">Loading...</span>
</div>

<div id="teamDetails">
    <div class="empty-state">Loading team details...</div>
</div>

<div class="section" id="matchHistory" style="margin-top: 20px;">
    <h2>Match History</h2>
    <div id="matchesList">
        <div class="empty-state">Loading matches...</div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const teamId = '{{ team_id }}';

    async function loadTeamDetails() {
        try {
            const response = await fetch('/api/teams');
            const teams = await response.json();
            const team = teams[teamId];

            if (!team) {
                document.getElementById('teamDetails').innerHTML = '<div class="empty-state">Team not found</div>';
                return;
            }

            document.getElementById('teamNameBreadcrumb').textContent = team.name;

            const winRate = team.wins + team.losses > 0 
                ? Math.round(team.wins / (team.wins + team.losses) * 100) 
                : 0;

            document.getElementById('teamDetails').innerHTML = `
                <div class="header-actions">
                    <div>
                        <h1>${team.name}</h1>
                        <p style="color: #6b7280; margin-top: 5px;">Captain: ${team.captain}</p>
                    </div>
                </div>
                
                <div class="section">
                    <h2>Statistics</h2>
                    <div class="stats" style="justify-content: flex-start; gap: 40px;">
                        <div class="stat">
                            <div class="stat-value" style="font-size: 2em; color: #10b981;">${team.wins}</div>
                            <div class="stat-label">Wins</div>
                        </div>
                        <div class="stat">
                            <div class="stat-value" style="font-size: 2em; color: #ef4444;">${team.losses}</div>
                            <div class="stat-label">Losses</div>
                        </div>
                        <div class="stat">
                            <div class="stat-value" style="font-size: 2em;">${team.wins + team.losses}</div>
                            <div class="stat-label">Total Matches</div>
                        </div>
                        <div class="stat">
                            <div class="stat-value" style="font-size: 2em;">${winRate}%</div>
                            <div class="stat-label">Win Rate</div>
                        </div>
                    </div>
                </div>
            `;

            loadMatchHistory(teams);
        } catch (error) {
            console.error('Error loading team details:', error);
            document.getElementById('teamDetails').innerHTML = '<div class="empty-state">Error loading team details</div>';
        }
    }

    async function loadMatchHistory(teams) {
        try {
            const response = await fetch('/api/matches');
            const matches = await response.json();

            const teamMatches = matches.filter(m => m.team1 === teamId || m.team2 === teamId);
            const container = document.getElementById('matchesList');

            if (teamMatches.length === 0) {
                container.innerHTML = '<div class="empty-state">No matches played yet</div>';
                return;
            }

            container.innerHTML = `
                <table>
                    <thead>
                        <tr>
                            <th>Round</th>
                            <th>Opponent</th>
                            <th>Result</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${teamMatches.map(match => {
                            const opponentId = match.team1 === teamId ? match.team2 : match.team1;
                            const opponent = teams[opponentId];
                            const isWinner = match.winner === teamId;
                            const isLoser = match.winner && match.winner !== teamId;
                            
                            let resultText = 'Pending';
                            let resultStyle = 'color: #6b7280;';
                            if (isWinner) {
                                resultText = 'Won';
                                resultStyle = 'color: #10b981; font-weight: 600;';
                            } else if (isLoser) {
                                resultText = 'Lost';
                                resultStyle = 'color: #ef4444; font-weight: 600;';
                            } else if (match.status === 'abandoned') {
                                resultText = 'Abandoned';
                                resultStyle = 'color: #6b7280;';
                            }

                            return `
                                <tr>
                                    <td>Round ${match.round || '?'}</td>
                                    <td>${opponent ? opponent.name : 'Unknown'}</td>
                                    <td style="${resultStyle}">${resultText}</td>
                                    <td><span class="badge badge-${match.status === 'completed' ? 'completed' : match.status === 'pending' ? 'registration' : 'active'}">${match.status}</span></td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            `;
        } catch (error) {
            console.error('Error loading match history:', error);
        }
    }

    loadTeamDetails();
</script>
{% endblock %}
