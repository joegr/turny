{% extends "base.html" %}

{% block title %}Dashboard{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Header -->
    <div class="flex justify-between items-center">
        <div>
            <h1 class="text-3xl font-bold">Dashboard</h1>
            <p class="text-gray-400">Welcome, {{ user.display_name or user.username }}</p>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Subscriptions -->
        <div class="lg:col-span-2 bg-gray-800 rounded-lg border border-gray-700">
            <div class="px-6 py-4 border-b border-gray-700">
                <h2 class="text-xl font-semibold">Your Subscriptions</h2>
            </div>
            <div class="p-6">
                {% if subscriptions %}
                <div class="space-y-4">
                    {% for t in subscriptions %}
                    <div class="bg-gray-700 rounded-lg p-4 flex items-center justify-between">
                        <div class="flex items-center space-x-4">
                            <div class="w-10 h-10 rounded-lg flex items-center justify-center
                                {% if t.status == 'registration' %}bg-blue-900{% endif %}
                                {% if t.status == 'active' %}bg-green-900{% endif %}
                                {% if t.status == 'completed' %}bg-yellow-900{% endif %}
                            ">
                                {% if t.status == 'registration' %}
                                <i data-lucide="user-plus" class="w-5 h-5 text-blue-400"></i>
                                {% elif t.status == 'active' %}
                                <i data-lucide="swords" class="w-5 h-5 text-green-400"></i>
                                {% else %}
                                <i data-lucide="trophy" class="w-5 h-5 text-yellow-400"></i>
                                {% endif %}
                            </div>
                            <div>
                                <a href="/tournaments/{{ t.tournament_id }}" class="font-semibold hover:text-yellow-500">{{ t.name }}</a>
                                <p class="text-sm text-gray-400">{{ t.status.upper() }}</p>
                            </div>
                        </div>
                        <button onclick="unsubscribe('{{ t.tournament_id }}')" class="text-gray-400 hover:text-red-400">
                            <i data-lucide="x" class="w-5 h-5"></i>
                        </button>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="text-center py-8">
                    <i data-lucide="bell-off" class="w-16 h-16 mx-auto text-gray-600 mb-4"></i>
                    <p class="text-gray-400 mb-4">No subscriptions yet</p>
                    <a href="/tournaments" class="text-yellow-500 hover:text-yellow-400">Browse tournaments â†’</a>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Notifications Panel -->
        <div class="bg-gray-800 rounded-lg border border-gray-700">
            <div class="px-6 py-4 border-b border-gray-700">
                <h2 class="text-xl font-semibold">Live Notifications</h2>
            </div>
            <div class="p-6">
                <div id="notifications" class="space-y-3">
                    <p class="text-gray-500 text-center py-4">Listening for events...</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const notifications = [];
    
    function renderNotifications() {
        const container = document.getElementById('notifications');
        if (notifications.length === 0) {
            container.innerHTML = '<p class="text-gray-500 text-center py-4">No new notifications</p>';
            return;
        }
        container.innerHTML = notifications.map(n => `
            <div class="bg-gray-700 rounded-lg p-3">
                <p class="text-sm">${n.message}</p>
                <p class="text-xs text-gray-400 mt-1">${n.time}</p>
            </div>
        `).join('');
    }
    
    async function unsubscribe(tournamentId) {
        try {
            await fetch('/api/v1/subscriptions', {
                method: 'DELETE',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ tournament_id: tournamentId })
            });
            location.reload();
        } catch (err) {
            showToast('Failed to unsubscribe', 'error');
        }
    }
    
    lucide.createIcons();
    renderNotifications();
</script>
{% endblock %}
