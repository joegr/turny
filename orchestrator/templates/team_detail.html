{% extends "base.html" %}

{% block title %}{{ team.name }} - Team Details{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Breadcrumb Navigation -->
    <nav class="flex items-center space-x-2 text-sm">
        <a href="/" class="text-gray-400 hover:text-white transition-colors">Home</a>
        <i data-lucide="chevron-right" class="w-4 h-4 text-gray-600"></i>
        <a href="/tournaments/{{ tournament_id }}" class="text-gray-400 hover:text-white transition-colors">Tournament</a>
        <i data-lucide="chevron-right" class="w-4 h-4 text-gray-600"></i>
        <span class="text-yellow-500 font-medium">{{ team.name }}</span>
    </nav>

    <!-- Team Header Card -->
    <div class="bg-gradient-to-br from-gray-800 via-gray-800 to-gray-900 rounded-2xl border border-gray-700 overflow-hidden">
        <div class="p-8">
            <div class="flex flex-col lg:flex-row lg:items-start lg:justify-between gap-6">
                <!-- Team Info -->
                <div class="flex items-start space-x-6">
                    <div class="w-20 h-20 rounded-2xl bg-gradient-to-br from-yellow-500/20 to-yellow-600/10 border border-yellow-500/30 flex items-center justify-center flex-shrink-0">
                        <i data-lucide="shield" class="w-10 h-10 text-yellow-500"></i>
                    </div>
                    <div>
                        <h1 class="text-3xl font-bold text-white mb-2" id="team-name">{{ team.name }}</h1>
                        <div class="flex items-center text-gray-400 mb-4">
                            <i data-lucide="user" class="w-4 h-4 mr-2"></i>
                            <span>Captain: <span class="text-white font-medium" id="team-captain">{{ team.captain }}</span></span>
                        </div>
                        <div class="flex flex-wrap gap-2">
                            <span class="px-3 py-1 rounded-full bg-gray-700 text-gray-300 text-sm font-medium" id="team-group"></span>
                        </div>
                    </div>
                </div>
                
                <!-- ELO Rating Display -->
                <div class="text-center lg:text-right">
                    <div class="inline-block bg-gray-900/50 rounded-2xl p-6 border border-gray-700">
                        <p class="text-gray-400 text-sm font-medium mb-1">ELO Rating</p>
                        <p class="text-5xl font-bold text-yellow-500" id="team-elo">{{ team.elo_rating }}</p>
                        <div class="mt-2" id="elo-change-badge"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Stats Grid -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
        <div class="bg-gray-800 rounded-xl p-5 border border-gray-700">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-400 text-sm">Wins</p>
                    <p class="text-3xl font-bold text-green-500 mt-1" id="stat-wins">0</p>
                </div>
                <div class="w-12 h-12 rounded-xl bg-green-500/10 flex items-center justify-center">
                    <i data-lucide="trophy" class="w-6 h-6 text-green-500"></i>
                </div>
            </div>
        </div>
        <div class="bg-gray-800 rounded-xl p-5 border border-gray-700">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-400 text-sm">Losses</p>
                    <p class="text-3xl font-bold text-red-500 mt-1" id="stat-losses">0</p>
                </div>
                <div class="w-12 h-12 rounded-xl bg-red-500/10 flex items-center justify-center">
                    <i data-lucide="x-circle" class="w-6 h-6 text-red-500"></i>
                </div>
            </div>
        </div>
        <div class="bg-gray-800 rounded-xl p-5 border border-gray-700">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-400 text-sm">Draws</p>
                    <p class="text-3xl font-bold text-gray-300 mt-1" id="stat-draws">0</p>
                </div>
                <div class="w-12 h-12 rounded-xl bg-gray-500/10 flex items-center justify-center">
                    <i data-lucide="minus-circle" class="w-6 h-6 text-gray-400"></i>
                </div>
            </div>
        </div>
        <div class="bg-gray-800 rounded-xl p-5 border border-gray-700">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-400 text-sm">Win Rate</p>
                    <p class="text-3xl font-bold text-yellow-500 mt-1" id="stat-winrate">0%</p>
                </div>
                <div class="w-12 h-12 rounded-xl bg-yellow-500/10 flex items-center justify-center">
                    <i data-lucide="percent" class="w-6 h-6 text-yellow-500"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- Two Column Layout: ELO Chart + Match History -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- ELO History Chart -->
        <div class="bg-gray-800 rounded-xl border border-gray-700">
            <div class="px-6 py-4 border-b border-gray-700 flex items-center space-x-3">
                <div class="w-8 h-8 rounded-lg bg-yellow-500/10 flex items-center justify-center">
                    <i data-lucide="trending-up" class="w-4 h-4 text-yellow-500"></i>
                </div>
                <h2 class="text-lg font-semibold">ELO History</h2>
            </div>
            <div class="p-6">
                <div class="h-64" id="elo-chart-container">
                    <canvas id="elo-chart"></canvas>
                </div>
                <div id="elo-chart-empty" class="hidden text-center py-12">
                    <div class="w-16 h-16 rounded-full bg-gray-700/50 flex items-center justify-center mx-auto mb-3">
                        <i data-lucide="line-chart" class="w-8 h-8 text-gray-500"></i>
                    </div>
                    <p class="text-gray-400 text-sm">No match history yet</p>
                    <p class="text-gray-500 text-xs mt-1">ELO changes will appear after matches</p>
                </div>
            </div>
        </div>

        <!-- Match History -->
        <div class="bg-gray-800 rounded-xl border border-gray-700">
            <div class="px-6 py-4 border-b border-gray-700 flex items-center space-x-3">
                <div class="w-8 h-8 rounded-lg bg-purple-500/10 flex items-center justify-center">
                    <i data-lucide="history" class="w-4 h-4 text-purple-500"></i>
                </div>
                <h2 class="text-lg font-semibold">Match History</h2>
            </div>
            <div class="p-4 max-h-80 overflow-y-auto" id="match-history-container">
                <div class="text-center py-12">
                    <div class="w-16 h-16 rounded-full bg-gray-700/50 flex items-center justify-center mx-auto mb-3">
                        <i data-lucide="swords" class="w-8 h-8 text-gray-500"></i>
                    </div>
                    <p class="text-gray-400 text-sm">No matches played yet</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Goal Stats (for football-style tournaments) -->
    <div class="bg-gray-800 rounded-xl border border-gray-700" id="goal-stats-section">
        <div class="px-6 py-4 border-b border-gray-700 flex items-center space-x-3">
            <div class="w-8 h-8 rounded-lg bg-blue-500/10 flex items-center justify-center">
                <i data-lucide="target" class="w-4 h-4 text-blue-500"></i>
            </div>
            <h2 class="text-lg font-semibold">Goal Statistics</h2>
        </div>
        <div class="p-6">
            <div class="grid grid-cols-3 gap-6 text-center">
                <div>
                    <p class="text-4xl font-bold text-green-500" id="goals-for">0</p>
                    <p class="text-gray-400 text-sm mt-1">Goals For</p>
                </div>
                <div>
                    <p class="text-4xl font-bold text-red-500" id="goals-against">0</p>
                    <p class="text-gray-400 text-sm mt-1">Goals Against</p>
                </div>
                <div>
                    <p class="text-4xl font-bold" id="goal-difference">0</p>
                    <p class="text-gray-400 text-sm mt-1">Goal Difference</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
    window.currentTournamentId = '{{ tournament_id }}';
    const teamId = '{{ team_id }}';
    
    async function loadTeamDetail() {
        try {
            const response = await fetch(`/api/v1/play/{{ tournament_id }}/teams/${teamId}`);
            if (!response.ok) throw new Error('Failed to load team details');
            
            const data = await response.json();
            const { team, match_history, elo_history } = data;
            
            // Update team info
            document.getElementById('team-name').textContent = team.name;
            document.getElementById('team-captain').textContent = team.captain;
            document.getElementById('team-elo').textContent = team.elo_rating || 1500;
            
            // Group badge
            const groupEl = document.getElementById('team-group');
            if (team.group) {
                groupEl.textContent = `Group ${team.group}`;
                groupEl.classList.remove('hidden');
            } else {
                groupEl.classList.add('hidden');
            }
            
            // Stats
            document.getElementById('stat-wins').textContent = team.wins || 0;
            document.getElementById('stat-losses').textContent = team.losses || 0;
            document.getElementById('stat-draws').textContent = team.draws || 0;
            
            const total = (team.wins || 0) + (team.losses || 0) + (team.draws || 0);
            const winrate = total > 0 ? Math.round((team.wins / total) * 100) : 0;
            document.getElementById('stat-winrate').textContent = `${winrate}%`;
            
            // Goal stats
            document.getElementById('goals-for').textContent = team.goals_for || 0;
            document.getElementById('goals-against').textContent = team.goals_against || 0;
            const gd = (team.goals_for || 0) - (team.goals_against || 0);
            const gdEl = document.getElementById('goal-difference');
            gdEl.textContent = gd > 0 ? `+${gd}` : gd;
            gdEl.className = `text-4xl font-bold ${gd > 0 ? 'text-green-500' : gd < 0 ? 'text-red-500' : 'text-gray-300'}`;
            
            // ELO change badge
            if (elo_history && elo_history.length > 0) {
                const latest = elo_history[elo_history.length - 1];
                const change = parseInt(latest.rating_change, 10) || 0;
                const badgeEl = document.getElementById('elo-change-badge');
                const icon = change > 0 ? 'trending-up' : 'trending-down';
                const colorClass = change > 0 ? 'bg-green-500/20 text-green-400' : 'bg-red-500/20 text-red-400';
                badgeEl.innerHTML = `
                    <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium ${colorClass}">
                        <i data-lucide="${icon}" class="w-4 h-4 mr-1"></i>
                        ${change > 0 ? '+' : ''}${change} last match
                    </span>
                `;
                lucide.createIcons();
            }
            
            // Render match history
            renderMatchHistory(match_history, elo_history);
            
            // Render ELO chart
            renderEloChart(elo_history);
            
            lucide.createIcons();
        } catch (error) {
            console.error('Error loading team details:', error);
        }
    }
    
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    function renderMatchHistory(matches, eloHistory) {
        const container = document.getElementById('match-history-container');
        
        if (!matches || matches.length === 0) {
            return;
        }
        
        container.innerHTML = matches.map(match => {
            const eloChange = eloHistory?.find(h => h.match_id === match.match_id);
            const resultConfig = {
                'win': { bg: 'bg-green-500', text: 'W', border: 'border-green-500/30' },
                'loss': { bg: 'bg-red-500', text: 'L', border: 'border-red-500/30' },
                'draw': { bg: 'bg-gray-500', text: 'D', border: 'border-gray-500/30' },
                'pending': { bg: 'bg-gray-600', text: 'â€”', border: 'border-gray-600/30' }
            };
            const config = resultConfig[match.result] || resultConfig.pending;
            const safeOpponent = escapeHtml(match.opponent || 'Unknown');
            const safeRound = parseInt(match.round, 10) || 0;
            const safeChange = parseInt(eloChange?.rating_change, 10) || 0;
            
            return `
                <div class="flex items-center space-x-4 p-3 bg-gray-700/30 rounded-xl border ${config.border} mb-2">
                    <div class="w-10 h-10 rounded-xl ${config.bg} flex items-center justify-center font-bold text-white flex-shrink-0">
                        ${config.text}
                    </div>
                    <div class="flex-1 min-w-0">
                        <p class="text-white font-medium truncate">vs ${safeOpponent}</p>
                        <p class="text-gray-500 text-xs">Round ${safeRound}</p>
                    </div>
                    ${eloChange ? `
                        <div class="text-right">
                            <span class="text-sm font-semibold ${safeChange > 0 ? 'text-green-400' : 'text-red-400'}">
                                ${safeChange > 0 ? '+' : ''}${safeChange}
                            </span>
                        </div>
                    ` : ''}
                </div>
            `;
        }).join('');
    }
    
    function renderEloChart(eloHistory) {
        const chartContainer = document.getElementById('elo-chart-container');
        const emptyState = document.getElementById('elo-chart-empty');
        
        if (!eloHistory || eloHistory.length === 0) {
            chartContainer.classList.add('hidden');
            emptyState.classList.remove('hidden');
            return;
        }
        
        chartContainer.classList.remove('hidden');
        emptyState.classList.add('hidden');
        
        const ctx = document.getElementById('elo-chart');
        const pointColors = ['#EAB308', ...eloHistory.map(h => h.rating_change > 0 ? '#22C55E' : '#EF4444')];
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: ['Start', ...eloHistory.map((_, i) => `Match ${i + 1}`)],
                datasets: [{
                    label: 'ELO Rating',
                    data: [eloHistory[0]?.old_rating || 1500, ...eloHistory.map(h => h.new_rating)],
                    borderColor: '#EAB308',
                    backgroundColor: 'rgba(234, 179, 8, 0.1)',
                    borderWidth: 3,
                    tension: 0.4,
                    fill: true,
                    pointBackgroundColor: pointColors,
                    pointBorderColor: pointColors,
                    pointRadius: 6,
                    pointHoverRadius: 8
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        backgroundColor: '#1F2937',
                        titleColor: '#F3F4F6',
                        bodyColor: '#9CA3AF',
                        borderColor: '#374151',
                        borderWidth: 1,
                        padding: 12,
                        displayColors: false
                    }
                },
                scales: {
                    y: {
                        grid: { color: '#374151' },
                        ticks: { color: '#9CA3AF' }
                    },
                    x: {
                        grid: { display: false },
                        ticks: { color: '#9CA3AF' }
                    }
                }
            }
        });
    }
    
    loadTeamDetail();
    lucide.createIcons();
</script>
{% endblock %}
