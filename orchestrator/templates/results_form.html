<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ tournament_id }} - Live Tournament</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen">
    <header class="bg-gray-800 border-b border-gray-700 py-4">
        <div class="max-w-6xl mx-auto px-4 flex items-center justify-between">
            <div class="flex items-center space-x-4">
                <i data-lucide="trophy" class="w-8 h-8 text-yellow-500"></i>
                <div>
                    <h1 class="text-xl font-bold">Tournament: {{ tournament_id }}</h1>
                    <div class="flex items-center space-x-3 text-sm text-gray-400">
                        <span class="capitalize">{{ tournament_type.replace('_', ' ') }}</span>
                        <span class="px-2 py-0.5 rounded-full text-xs font-semibold
                            {% if state == 'registration' %}bg-blue-900 text-blue-300{% endif %}
                            {% if state == 'active' %}bg-green-900 text-green-300{% endif %}
                            {% if state == 'completed' %}bg-yellow-900 text-yellow-300{% endif %}
                        ">{{ state.upper() }}</span>
                    </div>
                </div>
            </div>
            <div class="flex items-center space-x-4">
                <a href="/tournaments/{{ tournament_id }}/play" 
                   class="px-4 py-2 bg-gray-700 hover:bg-gray-600 text-white rounded-lg transition-colors flex items-center space-x-2">
                    <i data-lucide="git-branch" class="w-4 h-4"></i>
                    <span>Bracket View</span>
                </a>
                <button class="px-4 py-2 bg-yellow-500 text-gray-900 rounded-lg font-semibold">
                    List View
                </button>
                <div class="flex items-center space-x-2 text-sm">
                    <span class="w-2 h-2 rounded-full bg-gray-500" id="status-dot"></span>
                    <span id="status-text">Connecting...</span>
                </div>
            </div>
        </div>
    </header>

    <main class="max-w-6xl mx-auto py-6 px-4">
        {% if form_access == 'signup' %}
        <div class="space-y-6">
            <div class="bg-gray-800 rounded-lg border border-gray-700 p-6">
                <h2 class="text-xl font-semibold mb-4">Team Registration</h2>
                <form id="register-form" class="space-y-4 max-w-md">
                    <div>
                        <label class="block text-sm text-gray-400 mb-1">Team Name</label>
                        <input type="text" name="name" required class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 focus:outline-none focus:border-yellow-500">
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-1">Captain Name</label>
                        <input type="text" name="captain" required class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 focus:outline-none focus:border-yellow-500">
                    </div>
                    <button type="submit" class="bg-yellow-500 hover:bg-yellow-600 text-gray-900 font-bold py-2 px-4 rounded-lg">Register Team</button>
                </form>
            </div>
            <div class="bg-gray-800 rounded-lg border border-gray-700 p-6">
                <h2 class="text-xl font-semibold mb-4">Registered Teams</h2>
                <div id="teams-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <p class="text-gray-500">Loading...</p>
                </div>
            </div>
        </div>

        {% elif form_access == 'results' %}
        <div class="space-y-6">
            <div class="bg-gray-800 rounded-lg border border-gray-700 p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <h2 class="text-2xl font-bold">Round <span id="current-round">-</span><span id="total-rounds-display"></span></h2>
                        <p class="text-gray-400" id="matches-status">Loading matches...</p>
                    </div>
                    <div class="text-right">
                        <span class="text-3xl font-bold text-yellow-500" id="completed-count">0</span>
                        <span class="text-gray-400">/</span>
                        <span class="text-xl" id="total-count">0</span>
                        <p class="text-sm text-gray-400">matches completed</p>
                    </div>
                </div>
            </div>
            <div id="matches-grid" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <p class="text-gray-500 col-span-full text-center py-8">Loading matches...</p>
            </div>
            <div class="bg-gray-800 rounded-lg border border-gray-700">
                <div class="px-6 py-4 border-b border-gray-700">
                    <h2 class="text-xl font-semibold">Standings</h2>
                </div>
                <div class="p-6">
                    <table class="w-full">
                        <thead>
                            <tr class="text-left text-gray-400 text-sm">
                                <th class="pb-3">Rank</th>
                                <th class="pb-3">Team</th>
                                <th class="pb-3 text-center">W</th>
                                <th class="pb-3 text-center">L</th>
                                <th class="pb-3 text-right">Win %</th>
                            </tr>
                        </thead>
                        <tbody id="standings-body"></tbody>
                    </table>
                </div>
            </div>
        </div>

        {% elif form_access == 'readonly' %}
        <div class="space-y-6">
            <div class="bg-gray-800 rounded-lg border border-gray-700 p-6 text-center">
                <i data-lucide="trophy" class="w-24 h-24 mx-auto text-yellow-500 mb-4"></i>
                <h2 class="text-3xl font-bold mb-2">Tournament Completed</h2>
                <p class="text-gray-400 mb-6">Final results are now available</p>
                <div class="bg-yellow-900 bg-opacity-30 rounded-lg p-6 max-w-md mx-auto">
                    <p class="text-yellow-500 text-sm mb-2">CHAMPION</p>
                    <p class="text-2xl font-bold" id="winner-name">Loading...</p>
                </div>
            </div>
            <div class="bg-gray-800 rounded-lg border border-gray-700">
                <div class="px-6 py-4 border-b border-gray-700">
                    <h2 class="text-xl font-semibold">Final Standings</h2>
                </div>
                <div class="p-6">
                    <table class="w-full">
                        <thead>
                            <tr class="text-left text-gray-400 text-sm">
                                <th class="pb-3">Rank</th>
                                <th class="pb-3">Team</th>
                                <th class="pb-3 text-center">W</th>
                                <th class="pb-3 text-center">L</th>
                                <th class="pb-3 text-right">Win %</th>
                            </tr>
                        </thead>
                        <tbody id="standings-body"></tbody>
                    </table>
                </div>
            </div>
        </div>
        {% endif %}
    </main>

    <div id="toast-container" class="fixed bottom-4 right-4 space-y-2 z-50"></div>

    <script>
        lucide.createIcons();
        const formAccess = '{{ form_access }}';
        let teams = {};
        let pollingInterval = null;

        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            const colors = { 'info': 'bg-blue-600', 'success': 'bg-green-600', 'error': 'bg-red-600' };
            toast.className = `${colors[type]} text-white px-4 py-3 rounded-lg shadow-lg`;
            toast.textContent = message;
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 5000);
        }

        // Poll for updates every 5 seconds
        async function pollUpdates() {
            await Promise.all([loadState(), loadMatches(), loadStandings()]);
        }
        
        async function loadState() {
            try {
                const stateResp = await fetch(`/api/v1/play/{{ tournament_id }}/state`);
                if (!stateResp.ok) return;
                
                const stateData = await stateResp.json();
                
                // Update header status
                const statusBadge = document.querySelector('.rounded-full.text-xs');
                if (statusBadge) statusBadge.textContent = stateData.state.toUpperCase();
                
                document.getElementById('status-dot').className = 'w-2 h-2 rounded-full bg-green-500';
                document.getElementById('status-text').textContent = 'Live';
            } catch (error) {
                console.error('Error loading state:', error);
            }
        }
        
        // Setup SSE for real-time updates
        const eventSource = new EventSource(`/api/v1/play/{{ tournament_id }}/events`);
        
        eventSource.onmessage = (event) => {
            const data = JSON.parse(event.data);
            console.log('Received event:', data);
            
            // Update UI based on event type
            if (data.event_type === 'connected') {
                updateStatus('Connected', true);
            } else if (['team_registered', 'match_completed', 'round_advanced', 'matches_created', 'tournament_started'].includes(data.event_type)) {
                pollUpdates(); // Refresh data
            }
        };
        
        eventSource.onerror = (error) => {
            console.error('SSE error:', error);
            updateStatus('Connection lost - retrying...', false);
            // Fallback to polling if SSE fails
            setInterval(pollUpdates, 5000);
        };
        
        function updateStatus(text, connected) {
            const statusDot = document.getElementById('status-dot');
            const statusText = document.getElementById('status-text');
            if (statusDot) {
                statusDot.className = `w-2 h-2 rounded-full ${connected ? 'bg-green-500' : 'bg-gray-500'}`;
            }
            if (statusText) {
                statusText.textContent = text;
            }
        }

        async function loadTeams() {
            const resp = await fetch(`/api/v1/play/{{ tournament_id }}/teams`);
            teams = await resp.json();
            if (formAccess === 'signup') renderTeamsList();
        }

        function renderTeamsList() {
            const container = document.getElementById('teams-list');
            const arr = Object.entries(teams);
            if (!arr.length) { container.innerHTML = '<p class="text-gray-500 col-span-full">No teams registered yet</p>'; return; }
            container.innerHTML = arr.map(([id, t]) => `
                <a href="/tournaments/{{ tournament_id }}/teams/${t.team_id}" class="bg-gray-700 rounded-lg p-4 hover:bg-gray-600 hover:border-yellow-500/50 border border-transparent transition-all block">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold text-white">${t.name}</h3>
                            <p class="text-sm text-gray-400">Captain: ${t.captain}</p>
                        </div>
                        <div class="text-right">
                            <span class="text-yellow-500 font-semibold">${t.elo_rating || 1500}</span>
                            <p class="text-xs text-gray-500">ELO</p>
                        </div>
                    </div>
                </a>
            `).join('');
        }

        async function loadMatches() {
            if (formAccess !== 'results' && formAccess !== 'readonly') return;
            const matchesResp = await fetch(`/api/v1/play/{{ tournament_id }}/matches`);
            const matches = await matchesResp.json();
            
            // We need current round from state or infer it
            // For MVP let's assume matches contains round info or we fetch state separately which we do in pollUpdates
            // But here we need to update the UI counts
            
            const completed = matches.filter(m => m.status === 'completed').length;
            const completedEl = document.getElementById('completed-count');
            const totalEl = document.getElementById('total-count');
            const statusEl = document.getElementById('matches-status');
            
            if (completedEl) completedEl.textContent = completed;
            if (totalEl) totalEl.textContent = matches.length;
            if (statusEl) statusEl.textContent = completed === matches.length ? 'All matches completed!' : `${matches.length - completed} matches pending`;
            
            // Update round number if element exists
            const roundEl = document.getElementById('current-round');
            if (roundEl && matches.length > 0) {
                 const maxRound = Math.max(...matches.map(m => m.round || 1));
                 roundEl.textContent = maxRound;
            }

            renderMatches(matches);
        }

        function renderMatches(matches) {
            const container = document.getElementById('matches-grid');
            if (!container) return;
            if (!matches.length) { container.innerHTML = '<p class="text-gray-500 col-span-full text-center py-8">No matches yet</p>'; return; }
            container.innerHTML = matches.map(m => {
                const t1 = teams[m.team1] || { name: m.team1 || 'TBD', team_id: m.team1 };
                const t2 = teams[m.team2] || { name: m.team2 || 'TBD', team_id: m.team2 };
                const pending = m.status === 'pending';
                const t1Link = m.team1 ? `/tournaments/{{ tournament_id }}/teams/${m.team1}` : '#';
                const t2Link = m.team2 ? `/tournaments/{{ tournament_id }}/teams/${m.team2}` : '#';
                return `
                    <div class="bg-gray-800 rounded-lg border ${pending ? 'border-yellow-500' : 'border-gray-700'} p-4">
                        <div class="flex items-center justify-between mb-3">
                            <span class="text-sm text-gray-400">${m.id}</span>
                            <span class="px-2 py-0.5 rounded text-xs ${m.status === 'completed' ? 'bg-green-900 text-green-300' : 'bg-yellow-900 text-yellow-300'}">${m.status.toUpperCase()}</span>
                        </div>
                        <div class="space-y-2">
                            <div class="w-full p-3 rounded-lg flex items-center justify-between ${m.winner === m.team1 ? 'bg-green-900 border-2 border-green-500' : 'bg-gray-700'}">
                                <a href="${t1Link}" class="font-semibold hover:text-yellow-400 transition-colors" onclick="event.stopPropagation()">${t1.name}</a>
                                <div class="flex items-center space-x-2">
                                    ${m.winner === m.team1 ? '<i data-lucide="trophy" class="w-5 h-5 text-yellow-500"></i>' : ''}
                                    ${pending ? `<input type="number" id="score1-${m.id}" min="0" value="0" class="w-12 text-center p-1 bg-gray-600 border border-gray-500 rounded text-white text-sm">` : `<span class="text-lg font-bold">${m.team1_score ?? '-'}</span>`}
                                </div>
                            </div>
                            <div class="text-center text-gray-500 text-sm">VS</div>
                            <div class="w-full p-3 rounded-lg flex items-center justify-between ${m.winner === m.team2 ? 'bg-green-900 border-2 border-green-500' : 'bg-gray-700'}">
                                <a href="${t2Link}" class="font-semibold hover:text-yellow-400 transition-colors" onclick="event.stopPropagation()">${t2.name}</a>
                                <div class="flex items-center space-x-2">
                                    ${m.winner === m.team2 ? '<i data-lucide="trophy" class="w-5 h-5 text-yellow-500"></i>' : ''}
                                    ${pending ? `<input type="number" id="score2-${m.id}" min="0" value="0" class="w-12 text-center p-1 bg-gray-600 border border-gray-500 rounded text-white text-sm">` : `<span class="text-lg font-bold">${m.team2_score ?? '-'}</span>`}
                                </div>
                            </div>
                            ${pending ? `
                            <button onclick="recordResultWithScores('${m.id}', '${m.team1}', '${m.team2}')" class="w-full mt-2 py-2 bg-yellow-500 hover:bg-yellow-400 text-gray-900 font-bold rounded transition-colors">
                                Record Result
                            </button>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
            lucide.createIcons();
        }

        async function recordResult(matchId, winner) {
            const resp = await fetch(`/api/v1/play/{{ tournament_id }}/matches/${matchId}/result`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ winner })
            });
            if (resp.ok) { 
                showToast('Result recorded!', 'success'); 
                loadMatches(); 
                loadStandings(); 
            }
            else { 
                const err = await resp.json(); 
                showToast(err.error || 'Failed', 'error'); 
            }
        }

        async function recordResultWithScores(matchId, team1Id, team2Id) {
            const score1 = parseInt(document.getElementById(`score1-${matchId}`)?.value || 0);
            const score2 = parseInt(document.getElementById(`score2-${matchId}`)?.value || 0);
            
            // Determine winner or draw
            let body = {
                team1_score: score1,
                team2_score: score2
            };
            
            if (score1 > score2) {
                body.winner = team1Id;
            } else if (score2 > score1) {
                body.winner = team2Id;
            } else {
                body.is_draw = true;
            }
            
            const resp = await fetch(`/api/v1/play/{{ tournament_id }}/matches/${matchId}/result`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body)
            });
            if (resp.ok) { 
                showToast('Result recorded!', 'success'); 
                loadMatches(); 
                loadStandings(); 
            }
            else { 
                const err = await resp.json(); 
                showToast(err.error || 'Failed', 'error'); 
            }
        }

        async function loadStandings() {
            const resp = await fetch(`/api/v1/play/{{ tournament_id }}/standings`);
            const standings = await resp.json();
            const tbody = document.getElementById('standings-body');
            if (!tbody) return;
            tbody.innerHTML = standings.map((s, i) => `
                <tr class="border-t border-gray-700 hover:bg-gray-700/30 cursor-pointer" onclick="location.href='/tournaments/{{ tournament_id }}/teams/${s.team_id}'">
                    <td class="py-3">${i === 0 ? 'ðŸ¥‡' : i === 1 ? 'ðŸ¥ˆ' : i === 2 ? 'ðŸ¥‰' : s.rank}</td>
                    <td class="py-3 font-semibold hover:text-yellow-400 transition-colors">${s.name}</td>
                    <td class="py-3 text-center text-green-400">${s.wins}</td>
                    <td class="py-3 text-center text-red-400">${s.losses}</td>
                    <td class="py-3 text-right">${s.win_rate}%</td>
                </tr>
            `).join('');
            const winnerEl = document.getElementById('winner-name');
            if (winnerEl && standings.length) winnerEl.textContent = standings[0].name;
        }

        if (formAccess === 'signup') {
            document.getElementById('register-form').onsubmit = async (e) => {
                e.preventDefault();
                const form = e.target;
                const resp = await fetch(`/api/v1/play/{{ tournament_id }}/teams`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name: form.name.value, captain: form.captain.value })
                });
                if (resp.ok) { showToast('Team registered!', 'success'); form.reset(); loadTeams(); }
                else { const err = await resp.json(); showToast(err.error || 'Failed', 'error'); }
            };
        }

        // Initialize: load data on page load
        async function init() {
            await loadTeams();
            await loadMatches();
            await loadStandings();
            updateStatus('Connected', true);
        }
        
        init();
    </script>
</body>
</html>
